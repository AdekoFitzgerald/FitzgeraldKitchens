;******************************************
;*     OMAKSAN V2 POST PROCESSOR FILE  	  *
;*            a.k.a PART2CAM              *
;*       Cr.Aut:Ozan Cr.Year:2020	      *
;******************************************

;lmm_exportOmaksanGCodesDesiredCAMOp ; "imalat dxf" tarafýndan çaðrýlan ana fonksiyon

;ad_OmaksanCAMOperationList ;Cam operasyonlarýnýn sýrasý ile tanýmladýðý listedir. Genelde panellerin üst delikleri sonra kertme delikleri sonra yan delikleri ve en son kanal iþlemleri yapýalcak þekilde tanýmlanýr. 
							;eðer Gola Layerlarýda yapýlmasý istenirse yine gola layerýna frezeleme cam oprasyonu tanýmlanmalýdýr. 
							
;omaksanV2HoleCAMOperation ; Üst sol sað arka ön delik operasyonlarý için CAM operasyon rutini
;örnek cam style : (list "O1_8.0" "T1" "HOLE")
;örnek cam style : (list "O2_8.0" "T1" "HOLE")
;örnek cam style açýklama:
		;(list  "O2_8.0" ; layer ismi yerine deliðin bulunduðu yüzey ve çapýyla  oluþturulmuþ bir kombinasyon kullanýlýr. Sýrasýyla üst , sol ,sað,ön,arka delikler için O1,O2,O3,O4,O5 kullanýlýr. Bu layer ismi "(O1 || O2 || O3 || O4 || O5)  + "_" + (cap)%.1f"  gibi olmak zorundadýr. çap deðeri ondalýk ayracýndan sonra tek sayý olacak þekilde yazýlmalýdýr.
		;		"T1" 	; hangi takým kullanýlacaðý belirtilmeli
		;		"HOLE") ; ve delik iþlemi yapýlacaðý belirtilemeli

;omaksanV2MillingCAMOperation ; frezeleme CAM operasyonu yapan rutin
 ;cam style açýklamasý: "Layer ismi" "Kullanýlacak takým" "CAM operasyonu omaksan ismi(milling için MILLING)" "kalýnlýðý kaç defada iþleyecek" "alttan nekadar taþacak +" "takým kaydýrmasý" "sað veya sol ise miktarý" "topPlaneSafetyOffset"
 ;örnek cam style: (list "Groove_8" "T1" "MILLING" 2 0 0 0 "CENTER" 0 )
 ;örnek cam style: (list "Groove_8" "T1" "MILLING" 2 0 0 0 "INSIDE" 2 ) 
 ;örnek cam style: (list "Groove_8" "Layer ismi"
						;"T1" 		"Kullanýlacak takým"
						;"MILLING" 	"CAM operasyonu omaksan ismi(saw için MILLING)"
						;2 			"kalýnlýðý kaç defada iþleyecek"
						;0 			"alttan nekadar taþacak (+deðer ise  aþaðý doðru)"
						;0 			"ust yüzeyden yaklaþma duzlem mesafesi"
						;0 			"son paso miktarý"
						;"INSIDE"		"takým kaydýrmasý"  KLAVUZ ÝÇÝN BAKINIZ ../../Help/Frezeleme ve testerelme klavuzu.pdf
						;2			"sað veya sol kaydýrma var ise ise miktarý (herzaman + deðer olamlý)"
						;"F3000"		"iþleme hýzý"
						;"F600"		"dalma hýzý"
						;)
						
;omaksanV2SawCAMOperation ; testere cam oprasyonu. Var olan omaksan makineleri sadece x ekseni boyunca  testere iþlemi yapabilmektedir ve bu fonksiyon kendi içinde bunu kontrol eder.
						; Örneðin Y ekseni boyunca olan bir polyline 'a denk gelirse bunu yapamaz ve post dosyasý içine yorum olarak ekler. Bunu aþmak için Söz konusu panel reçeteden cevrilebilir.
;Aþaðýda Testere operasyonu nasýl tanýlanabileceði açýklanmýþtýr.
;örnek cam style: (list "Groove_8" "T1" "SAWX" 2 0 0 0 "CENTER" 0)
;cam style açýklamasý: "Layer ismi" "Kullanýlacak takým" "CAM operasyonu omaksan ismi(saw için SAWX)" "kalýnlýðý kaç defada iþleyecek" "alttan nekadar taþacak (+deðer ise  aþaðý doðru)" "ust yüzeyden yaklaþma duzlem mesafesi" "takým kaydýrmasý" "sað veya sol kaydýrma var ise ise miktarý"
;örnek cam style: (list "Groove_8" "Layer ismi"
						;"T1" 		"Kullanýlacak takým"
						;"SAWX" 		"CAM operasyonu omaksan ismi(saw için SAWX)"
						;2 			"kalýnlýðý kaç defada iþleyecek"
						;0 			"alttan nekadar taþacak (+deðer ise  aþaðý doðru)"
						;0 			"ust yüzeyden yaklaþma duzlem mesafesi"
						;0 			"son paso miktarý"
						;"INSIDE"		"takým kaydýrmasý" KLAVUZ ÝÇÝN BAKINIZ ../../Help/Frezeleme ve testerelme klavuzu.pdf
						;2			"sað veya sol kaydýrma var ise ise takýmýn yarýçap miktarý (herzaman + deðer olamlý)"
						;"F30"		"iþleme hýzý"
						;)


;Delikler için LAYERNAME yerine delikyüzeyi ve çapý, arasýnda alttan çizgi ile birlikte yazýlarak delik tanýmlamasý yapýlmalý. Örneðin üstteki 5mm çapýndaki delik için TOP_5 ,
;Kanallar için LAYERNAME yerine layer name yazýlabilir. 
;;LAYERNAME , TOOL , CAM operation type (O1 , O2 , O3 , O4 , O5     SAWX testere MILLING Freze)

;(setq omaksanToolList(list
;							(list "DIKMATKAP_3.0" "TAKIM NO" 2 )
;							(list "DIKMATKAP_5.0" "TAKIM NO" 4 )
;							(list "DIKMATKAP_8.0" "TAKIM NO" 7 )
;							(list "DIKMATKAP_10.0" "TAKIM NO" 6 )
;							(list "DIKMATKAP_15.0" "TAKIM NO" 1 )
;							(list "DIKMATKAP_35.0" "TAKIM NO" 5 )
;							(list "KAFADELIK+X_8.0" "TAKIM NO" 1 )
;							(list "KAFADELIK-X_8.0" "TAKIM NO" 1 )
;							(list "YANDELIK+Y_8.0" "TAKIM NO" 1 )
;							(list "YANDELIK-Y_8.0" "TAKIM NO" 1 )
;
;
;))

(setq ad_OmaksanCAMOperationList (list
										(list "O1_3.0" "M11 VA0 VB2 VC2" "HOLE")
										(list "O1_5.0" "M11 VA0 VB4 VC8" "HOLE")
										(list "O1_8.0" "M11 VA0 VB7 VC64" "HOLE")
										(list "O1_10.0" "M11 VA0 VB6 VC32" "HOLE")
										(list "O1_15.0" "M11 VA0 VB1 VC1" "HOLE")
										(list "O1_35.0" "M11 VA0 VB5 VC16" "HOLE")
										(list "NOTCH" "1" "MILLING" 2 1 0 0 "INSIDE" 4 "F3000" "F600" T)
										(list "O2_8.0" "M11 VA1 VB1 VC1" "HOLE")
										(list "O3_8.0" "M11 VA2 VB1 VC1" "HOLE")
										(list "O4_8.0" "M11 VA3 VB1 VC1" "HOLE")
										(list "O5_8.0" "M11 VA4 VB1 VC1" "HOLE")
										;(list "GROOVE" "" "SAWX" 1 0 0 0 "OUTSIDE" 0 "F30")
										(list "GROOVE" "1" "MILLING" 1 0 0 0 "CENTER" 0 "F3000" "F600" nil)
										;(list "GOLA_LAYER_TOP_1" "T1" "MILLING" 1 0 0 0 "INSIDE" 0 "F30" nil)
										;(list "GOLA_LAYER_TOP_2 " "T1" "MILLING" 1 0 0 0 "INSIDE" 0 "F30" nil)	
 ))
 
 ;cam style açýklamasý: "Layer ismi" "Kullanýlacak takým" "CAM operasyonu omaksan ismi(saw için SAWX)" "kalýnlýðý kaç defada iþleyecek" "alttan nekadar taþacak (+deðer ise  aþaðý doðru)" "ust yüzeyden yaklaþma duzlem mesafesi" "takým kaydýrmasý" "sað veya sol kaydýrma var ise ise miktarý"
 ;örnek cam style: (list "Groove_8" "T1" "SAWX" 2 0 0 0 "CENTER" 0)
 ;örnek cam style: (list "Groove_8" "Layer ismi"
						;"T1" 		"Kullanýlacak takým"
						;"SAWX" 		"CAM operasyonu omaksan ismi(saw için SAWX)"
						;2 			"kalýnlýðý kaç defada iþleyecek"
						;0 			"alttan nekadar taþacak (+deðer ise  aþaðý doðru)"
						;0 			"ust yüzeyden yaklaþma duzlem mesafesi"
						;0 			"son paso miktarý"
						;"INSIDE"		"takým kaydýrmasý" 
						;2			"sað veya sol kaydýrma var ise ise takýmýn yarýçap miktarý (herzaman + deðer olamlý)"
						;"F3000"		"iþleme hýzý"
						;)
 ;ÖNEMLÝ NOT : Testere sadece x ekseninde bir çizgi üzerinde iþlme yapar.
 (setq omaksanV2SawCAMOperation nil)
 (defun omaksanV2SawCAMOperation ( tempEnt tempCAMStyle safetyPlane file / mrtn tempPoint tempPoints startPoint endPoint middlePoint 
																	polylineIsStraitAlongByXAxis currentZLevel stepZComponets
																	bottomZComponent topZComponent stepOfPasses tempDepth  
																	tempEndPoint )
	(setq polylineIsStraitAlongByXAxis T)
	(setq tempPoints (lmm_getPolylinePoints tempEnt))
	(setq startPoint (nth 0 tempPoints))
	(foreach tempPoint tempPoints ;SAW blade can cut only x direction. so we must check whether given polyline is suitable to cut or not.
		(if (not (equal (nth 1 startPoint) (nth 1 tempPoint) 6))
			(progn
				(setq polylineIsStraitAlongByXAxis nil)
			)
		)
	)
	(if polylineIsStraitAlongByXAxis 
		(progn 
			(setq endPoint (last tempPoints))
			(if (> (nth 0 startPoint) (nth 0 endpoint))
				(progn
					(setq tempEndPoint endPoint)
					(setq endPoint startPoint)
					(setq startPoint tempEndPoint)
				)
			)
			(setq tempDepth (lmm_getLMMdata tempEnt lmm-k-depth))
			(setq stepOfPasses 	(nth 3 tempCAMStyle))
			(setq bottomZComponent (+ (- tempDepth) (nth 4 tempCAMStyle) ) )
			(setq topZComponent (- 0.0 (nth 5 tempCAMStyle) ) )
			(setq stepZComponets (_calculateZlevels stepOfPasses topZComponent bottomZComponent (nth 6 tempCAMStyle)))
			(cond 
				( (equal "CENTER" (nth 7 tempCAMStyle))
					(setq tempPoints (list startPoint endPoint))
				)
				( (equal "INSIDE" (nth 7 tempCAMStyle))
					(setq startPoint (VectorAdd startPoint (list 0 (* (nth 8 tempCAMStyle) -1) 0) ))
					(setq endPoint (VectorAdd endPoint (list 0 (* (nth 8 tempCAMStyle) -1) 0) ))
					(setq tempPoints (list startPoint endPoint))
				)
				( (equal "OUTSIDE" (nth 7 tempCAMStyle))
					(setq startPoint (VectorAdd startPoint (list 0 (nth 8 tempCAMStyle) 0) ))
					(setq endPoint (VectorAdd endPoint (list 0 (nth 8 tempCAMStyle) 0) ))
					(setq tempPoints (list startPoint endPoint))
				)
			)
			(setq mrtn "")
			(foreach currentZLevel stepZComponets ; -9 -18
				;(if (equal mrtn "")
				;	(setq mrtn (strcat mrtn "" (nth 2 tempCAMStyle) " " (nth 1 tempCAMStyle) "\n" (nth 9 tempCAMStyle)))
				;	(setq mrtn (strcat mrtn "\n" (nth 2 tempCAMStyle) " " (nth 1 tempCAMStyle) "\n" (nth 9 tempCAMStyle)))
				;)
				;(setq mrtn (strcat mrtn "\n" 	"G0 X" (lmm_convertNumtoStringWithDigit (nth 0 startPoint) 3)
				;								" Y"   (lmm_convertNumtoStringWithDigit (nth 1 startPoint) 3)
				;								" Z"   (lmm_convertNumtoStringWithDigit topZComponent 3) ))
				;(setq mrtn (strcat mrtn "\n" 	"G1 X" (lmm_convertNumtoStringWithDigit (nth 0 endPoint) 3)
				;								" Y"   (lmm_convertNumtoStringWithDigit (nth 1 endPoint) 3)
				;								" Z"   (lmm_convertNumtoStringWithDigit currentZLevel 3) ))
												
				; M11 VA5 VB1 VC1 VD100 VE200 VF0 VG8 VH500
				(princ (sprintf "M11 VA5 VB1 VC1 VD~s VE~s VF0 VG~s VH~s\n" (list  (lmm_convertNumtoStringWithDigit (nth 0 startPoint) 3) 
																					(lmm_convertNumtoStringWithDigit (nth 1 startPoint) 3)
																					(lmm_convertNumtoStringWithDigit (* -1.0 currentZLevel) 3)
																					(lmm_convertNumtoStringWithDigit (VectorMag (VectorSub startPoint endPoint)) 3)
																			)) file)
			)
		)
		(progn
			(alert (strcat "//Testere uygulanamadý. Geometri uygun deðil.->" (lmm_getDXFFileNameByFileMode (list tempPanel)) ))
		)
	)
	;(write-line  mrtn file)
 )


;(equal (lmm_getLMMdata tempEnt lmm-k-type) "HOLE"
;(setq tempHolePos (getEntPro tempEnt 10))
 
 ;cam style açýklamasý: "Layer ismi" "Kullanýlacak takým" "CAM operasyonu omaksan ismi(milling için MILLING)" "kalýnlýðý kaç defada iþleyecek" "alttan nekadar taþacak +" "takým kaydýrmasý" "sað veya sol ise miktarý" "topPlaneSafetyOffset"
 ;örnek cam style: (list "Groove_8" "T1" "MILLING" 2 0 0 0 "CENTER" 0 )
 ;örnek cam style: (list "Groove_8" "T1" "MILLING" 2 0 0 0 "INSIDE" 2 ) 
 ;örnek cam style: (list "Groove_8" "Layer ismi"
						;"T1" 		"Kullanýlacak takým"
						;"MILLING" 	"CAM operasyonu omaksan ismi(saw için MILLING)"
						;2 			"kalýnlýðý kaç defada iþleyecek"
						;0 			"alttan nekadar taþacak (+deðer ise  aþaðý doðru)"
						;0 			"ust yüzeyden yaklaþma duzlem mesafesi"
						;0 			"son paso miktarý"
						;"INSIDE"		"takým kaydýrmasý" 
						;2			"sað veya sol kaydýrma var ise ise miktarý (herzaman + deðer olamlý)"
						;"F30"		"iþleme hýzý"
						;)

(setq omaksanV2MillingCAMOperation nil)
(defun omaksanV2MillingCAMOperation (currentEnt entLayerName tempCAMStyle currentPanel file /  deleteHelper tempDepth stepOfPasses
																bottomZComponent topZComponent stepZComponets cutFeedRate plungeFeedRate
																tempPoints helperEntity fieldPoint firstPoint secondPoint
																firstSecondNormal iteration currentZLevel tempPoint bulgeOfSegment
																radiusOfSegment tempPanelDepth
																maxSegDistance arcValues stepVal centerOfSegment lengthOfSegment totalRadOfSegment
																buffRadVec deltaAngle)
	;check m12 state
	(if (not (nth 0 m12m16State))
		(progn
			(setq m12m16State (list T (nth 1 m12m16State)))
			(princ "M12\n" gCodeFile)
		)
	)														
	(setq maxSegDistance 1.0)
	(setq deleteHelper nil)
	(setq tempPanelDepth (lmm_getLMMdata currentPanel lmm-k-depth))
	(setq tempDepth (lmm_getLMMdata currentEnt lmm-k-depth))
	(setq stepOfPasses 	(nth 3 tempCAMStyle))
	(setq bottomZComponent (+ (- tempDepth) (nth 4 tempCAMStyle) ) )
	(setq topZComponent (- 0.0 (nth 5 tempCAMStyle) ) )
	(setq stepZComponets (_calculateZlevels stepOfPasses topZComponent  bottomZComponent  (nth 6 tempCAMStyle)) )
	(setq cutFeedRate (nth 9 tempCAMStyle))
	(setq plungeFeedRate (nth 10 tempCAMStyle))
	
	;Center mý inside mý outside mý?
	(cond
	( (or (equal "CENTER" (nth 7 tempCAMStyle)) (equal (nth 8 tempCAMStyle) 0) ) 
			(setq tempPoints  (lmm_getPolylinePoints currentEnt) )
			(setq helperEntity currentEnt)
		)
		
		( (equal "INSIDE" (nth 7 tempCAMStyle))
			(setq tempPoints (lmm_getPolylinePoints currentEnt))
			(setq firstPoint (nth 0 tempPoints))
			(setq secondPoint (nth 1 tempPoints))
			(setq firstSecondNormal (normalizeVector (VectorSub secondPoint firstPoint)))
			(if (equal "CCW" (GetIrregularPointlistClockwiseOrder_2 tempPoints currentPanel (nth 11 tempCAMStyle)))
				(setq firstSecondNormal (VectorRotate firstSecondNormal 1))
				(setq firstSecondNormal (VectorRotate firstSecondNormal -1))
			)
			(setq fieldPoint (VectorAdd firstPoint firstSecondNormal))
			(OFFSET (nth 8 tempCAMStyle) (list tempEnt firstPoint) fieldPoint)
			(setq tempPoints (lmm_getPolylinePoints(entlast)))
			(setq helperEntity (entlast))
			(setq deleteHelper T)
		)
		
		( (equal "OUTSIDE" (nth 7 tempCAMStyle))
			(setq tempPoints (lmm_getPolylinePoints currentEnt))
			(setq firstPoint (nth 0 tempPoints))
			(setq secondPoint (nth 1 tempPoints))
			(setq firstSecondNormal (normalizeVector (VectorSub secondPoint firstPoint)))
			(if (equal "CCW" (GetIrregularPointlistClockwiseOrder_2 tempPoints currentPanel (nth 11 tempCAMStyle)))
				(setq firstSecondNormal (VectorRotate firstSecondNormal -1))
				(setq firstSecondNormal (VectorRotate firstSecondNormal 1))
			)
			(setq fieldPoint (VectorAdd firstPoint firstSecondNormal))
			(OFFSET (nth 8 tempCAMStyle) (list tempEnt firstPoint) fieldPoint)
			(setq tempPoints (lmm_getPolylinePoints(entlast)))
			(setq helperEntity (entlast))
			(setq deleteHelper T)
		)
	)

	;helper entitiyi kullanacaðýz
	(setq tempPointsWB (lmm_getPolylineDataAsProfile helperEntity (_ 0.0 0.0 0.0)))
	; (( x y z) b (x y z) b)
	
	(princ "G00 Z0.00\n" file)
	(princ "M15\n" file);Freze takýmý yukarý kaldýrma
	(princ (sprintf "M13 VA6 VB~s VC~s\n" (list (nth 1 tempCAMStyle) (nth 1 tempCAMStyle))) file)
	(princ (sprintf "M06 VA~s\n" (list (nth 1 tempCAMStyle))) file)
	(princ "M14\n" file)
	
	(foreach currentZLevel stepZComponets
		(setq iteration 1)
		(if (> (abs currentZLevel) (+ 2 tempPanelDepth) )
			(alert (sprintf "Takým çarpma riski hasýl oldu!!!\n ~s -> ~s\n Freze derinliði: ~d" (list (lmm_getDXFFileNameByFileMode (list tempPanel))
																	entLayerName
																	currentZLevel)))
		)
		
		(foreach tempPoint tempPoints
			(cond
				((equal 1 iteration) ; ilk harekat yaklaþma hareketlerinide yap
					(princ "G00 Z[-3+P3]\n" file)
					(princ (sprintf "G00 X~s Y~s\n" (list (lmm_convertNumtoStringWithDigit (nth 0 tempPoint) 3)
														 (lmm_convertNumtoStringWithDigit (nth 1 tempPoint) 3)
													)) 
					file)
					(princ (sprintf "G01 Z[~s+P3] ~s\n" (list (lmm_convertNumtoStringWithDigit (- currentZLevel) 3) plungeFeedRate )) file) ; plunge move
				)
				((and (< 1 iteration) (> (length tempPoints) iteration)) ; kesme hareketleri
					(setq bulgeOfSegment (nth (- (* 2 iteration) 3) tempPointsWB))
					(cond
						((equal 0.0 bulgeOfSegment)
							(princ (sprintf "G01 X~s Y~s ~s\n" 	(list (lmm_convertNumtoStringWithDigit (nth 0 tempPoint) 3)
															(lmm_convertNumtoStringWithDigit (nth 1 tempPoint) 3)
															cutFeedRate
													)) 
							file)
						)
						((> 0.0 bulgeOfSegment)
							(setq secondPoint (_ (nth 0 tempPoint) (nth 1 tempPoint) currentZLevel))
							(setq arcValues (calculatePolylineSegmentRadius firstPoint secondPoint bulgeOfSegment))
							;(setq centerOfSegment (nth 2 arcValues))
							;(setq lengthOfSegment (nth 3 arcValues))
							;(setq totalRadOfSegment (nth 4 arcValues))
							;(setq stepVal  (fix (round (/ lengthOfSegment maxSegDistance) 0)))
							;(setq buffRadVec (VectorSub firstPoint centerOfSegment))
							;(setq deltaAngle (* -1 (/ totalRadOfSegment stepVal)))
							;(setq stepVal (- stepVal 1))
							;(repeat stepVal
							;	(setq buffRadVec (rotatepoint buffRadVec deltaAngle (_ 0 0 0) ))
							;	(setq bufferPoint (VectorAdd centerOfSegment buffRadVec))
							;	(princ (sprintf "G01 X~s Y~s ~s\n" 
							;	(_ 
							;	(lmm_convertNumtoStringWithDigit (nth 0 bufferPoint) 3)
							;	(lmm_convertNumtoStringWithDigit (nth 1 bufferPoint) 3)
							;	cutFeedRate
							;	)) file)
							;)
							;(princ (sprintf "G01 X~s Y~s ~s\n"
							;(_ 
							;(lmm_convertNumtoStringWithDigit (nth 0 secondPoint) 3)
							;(lmm_convertNumtoStringWithDigit (nth 1 secondPoint) 3)
							;cutFeedRate
							;)) file)
							
							(princ (sprintf "G02 X~s Y~s R~s ~s\n"
							(_ 
							(lmm_convertNumtoStringWithDigit (nth 0 secondPoint) 3)
							(lmm_convertNumtoStringWithDigit (nth 1 secondPoint) 3)
							(lmm_convertNumtoStringWithDigit (nth 0 arcValues) 3)
							cutFeedRate
							)) file)
						)
						((< 0.0 bulgeOfSegment)
							(setq secondPoint (_ (nth 0 tempPoint) (nth 1 tempPoint) currentZLevel))
							(setq arcValues (calculatePolylineSegmentRadius firstPoint secondPoint bulgeOfSegment))
							;(setq centerOfSegment (nth 2 arcValues))
							;(setq lengthOfSegment (nth 3 arcValues))
							;(setq totalRadOfSegment (nth 4 arcValues))
							;(setq stepVal  (fix (round (/ lengthOfSegment maxSegDistance) 0)))
							;(setq buffRadVec (VectorSub firstPoint centerOfSegment))
							;(setq deltaAngle (/ totalRadOfSegment stepVal))
							;(setq stepVal (- stepVal 1))
							;(repeat stepVal
							;	(setq buffRadVec (rotatepoint buffRadVec deltaAngle (_ 0 0 0) ))
							;	(setq bufferPoint (VectorAdd centerOfSegment buffRadVec))
							;	(princ (sprintf "G01 X~s Y~s ~s\n" 
							;	(_ 
							;	(lmm_convertNumtoStringWithDigit (nth 0 bufferPoint) 3)
							;	(lmm_convertNumtoStringWithDigit (nth 1 bufferPoint) 3)
							;	cutFeedRate
							;	)) file)
							;)
							;(princ (sprintf "G01 X~s Y~s ~s\n"
							;(_ 
							;(lmm_convertNumtoStringWithDigit (nth 0 secondPoint) 3)
							;(lmm_convertNumtoStringWithDigit (nth 1 secondPoint) 3)
							;cutFeedRate
							;)) file)
							
							(princ (sprintf "G03 X~s Y~s R~s ~s\n"
							(_ 
							(lmm_convertNumtoStringWithDigit (nth 0 secondPoint) 3)
							(lmm_convertNumtoStringWithDigit (nth 1 secondPoint) 3)
							(lmm_convertNumtoStringWithDigit (nth 0 arcValues) 3)
							cutFeedRate
							)) file)
						)
					)
				)
				((equal (length tempPoints) iteration) ; son kesme hareketleri ve uzaklaþma hareketleri
					(setq bulgeOfSegment (nth (- (* 2 iteration) 3) tempPointsWB))
					(cond
						((equal 0.0 bulgeOfSegment)
							(princ (sprintf "G01 X~s Y~s ~s\n" 	(list (lmm_convertNumtoStringWithDigit (nth 0 tempPoint) 3)
															(lmm_convertNumtoStringWithDigit (nth 1 tempPoint) 3)
															cutFeedRate
													)) 
							file)
						)
						((> 0.0 bulgeOfSegment)
							(setq secondPoint (_ (nth 0 tempPoint) (nth 1 tempPoint) currentZLevel))
							(setq arcValues (calculatePolylineSegmentRadius firstPoint secondPoint bulgeOfSegment))
							;(setq centerOfSegment (nth 2 arcValues))
							;(setq lengthOfSegment (nth 3 arcValues))
							;(setq totalRadOfSegment (nth 4 arcValues))
							;(setq stepVal  (fix (round (/ lengthOfSegment maxSegDistance) 0)))
							;(setq buffRadVec (VectorSub firstPoint centerOfSegment))
							;(setq deltaAngle (* -1 (/ totalRadOfSegment stepVal)))
							;(setq stepVal (- stepVal 1))
							;(repeat stepVal
							;	(setq buffRadVec (rotatepoint buffRadVec deltaAngle (_ 0 0 0) ))
							;	(setq bufferPoint (VectorAdd centerOfSegment buffRadVec))
							;	(princ (sprintf "G01 X~s Y~s ~s\n" 
							;	(_ 
							;	(lmm_convertNumtoStringWithDigit (nth 0 bufferPoint) 3)
							;	(lmm_convertNumtoStringWithDigit (nth 1 bufferPoint) 3)
							;	cutFeedRate
							;	)) file)
							;)
							;(princ (sprintf "G01 X~s Y~s ~s\n"
							;(_ 
							;(lmm_convertNumtoStringWithDigit (nth 0 secondPoint) 3)
							;(lmm_convertNumtoStringWithDigit (nth 1 secondPoint) 3)
							;cutFeedRate
							;)) file)
							
							(princ (sprintf "G02 X~s Y~s R~s ~s\n"
							(_ 
							(lmm_convertNumtoStringWithDigit (nth 0 secondPoint) 3)
							(lmm_convertNumtoStringWithDigit (nth 1 secondPoint) 3)
							(lmm_convertNumtoStringWithDigit (nth 0 arcValues) 3)
							cutFeedRate
							)) file)
						)
						((< 0.0 bulgeOfSegment)
							(setq secondPoint (_ (nth 0 tempPoint) (nth 1 tempPoint) currentZLevel))
							(setq arcValues (calculatePolylineSegmentRadius firstPoint secondPoint bulgeOfSegment))
							;(setq centerOfSegment (nth 2 arcValues))
							;(setq lengthOfSegment (nth 3 arcValues))
							;(setq totalRadOfSegment (nth 4 arcValues))
							;(setq stepVal  (fix (round (/ lengthOfSegment maxSegDistance) 0)))
							;(setq buffRadVec (VectorSub firstPoint centerOfSegment))
							;(setq deltaAngle (/ totalRadOfSegment stepVal))
							;(setq stepVal (- stepVal 1))
							;(repeat stepVal
							;	(setq buffRadVec (rotatepoint buffRadVec deltaAngle (_ 0 0 0) ))
							;	(setq bufferPoint (VectorAdd centerOfSegment buffRadVec))
							;	(princ (sprintf "G01 X~s Y~s ~s\n" 
							;	(_ 
							;	(lmm_convertNumtoStringWithDigit (nth 0 bufferPoint) 3)
							;	(lmm_convertNumtoStringWithDigit (nth 1 bufferPoint) 3)
							;	cutFeedRate
							;	)) file)
							;)
							;(princ (sprintf "G01 X~s Y~s ~s\n"
							;(_ 
							;(lmm_convertNumtoStringWithDigit (nth 0 secondPoint) 3)
							;(lmm_convertNumtoStringWithDigit (nth 1 secondPoint) 3)
							;cutFeedRate
							;)) file)
							
							(princ (sprintf "G03 X~s Y~s R~s ~s\n"
							(_ 
							(lmm_convertNumtoStringWithDigit (nth 0 secondPoint) 3)
							(lmm_convertNumtoStringWithDigit (nth 1 secondPoint) 3)
							(lmm_convertNumtoStringWithDigit (nth 0 arcValues) 3)
							cutFeedRate
							)) file)
						)
					)
					(princ "G01 Z[-3+P3]\n" file)
				)
			)
			(setq iteration (+ 1 iteration))
		)
	)
	(princ "M05\nM15\n" file)
	(if deleteHelper (deleteEntity (entlast)))
	;check m16 state
	(if (not (nth 1 m12m16State))
		(progn
			(setq m12m16State (list (nth 0 m12m16State) T))
			(princ "M16\n" file)
		)
	)
)

(setq omaksanV2HoleCAMOperation nil)
(defun omaksanV2HoleCAMOperation ( currentEnt entLayerName tempCAMStyle currentPanel file / tempHolePos tempHoleDepth tempPanelCurrentHoleX tempPanelCurrentHoleY tempPanelCurrentHoleZ
																							tempOpToolName tempPanelDepth ikiyuzon)
	(setq tempHolePos (getEntPro currentEnt 10))
	(setq tempOpToolName (nth 1 currentOp))
	(setq tempHoleDepth (lmm_getLMMdata currentEnt lmm-k-depth))
	(setq tempPanelDepth (lmm_getLMMdata currentPanel lmm-k-depth))
	(cond
		( (equal "O1" (substr entLayerName 1 2))
			;Güvenlik 
			(if (> tempHoleDepth (+ tempPanelDepth 5))
				(alert (sprintf "Takým çarpma riski hasýl oldu!!!\n ~s -> ~s\n Delik derinliði: ~d" (list (lmm_getDXFFileNameByFileMode (list currentPanel))
																					entLayerName
																					tempHoleDepth)))
			)
			(princ (sprintf "~s VD~s VE~s VF0 VG~s VH0\n" (list (nth 1 tempCAMStyle)
						 (lmm_convertNumtoStringWithDigit (getnth 0 tempHolePos) 2)
						  (lmm_convertNumtoStringWithDigit (getnth 1 tempHolePos) 2)
						   (lmm_convertNumtoStringWithDigit tempHoleDepth 2)
						)) file)
			
		)
		( (equal "O3" (substr entLayerName 1 2))
			(setq ikiyuzon (getEntPro currentEnt 210))
			(setq tempHolePos (trans tempHolePos ikiyuzon 0))
			;Güvenlik 
			(if (> tempHoleDepth 35)
				(alert (sprintf "Takým çarpma riski hasýl oldu!!!\n ~s -> ~s\n Delik derinliði: ~d" (list (lmm_getDXFFileNameByFileMode (list currentPanel))
																					entLayerName
																					tempHoleDepth)))
			)
			(princ (sprintf "~s VD~s VE~s VF~s VG~s VH0\n" (list (nth 1 tempCAMStyle)
						 (lmm_convertNumtoStringWithDigit (getnth 0 tempHolePos) 2)
						  (lmm_convertNumtoStringWithDigit (getnth 1 tempHolePos) 2)
						  (lmm_convertNumtoStringWithDigit (* -1 (getnth 2 tempHolePos)) 2)
						   (lmm_convertNumtoStringWithDigit tempHoleDepth 2)
						)) file)
			
		)
		( (equal "O2" (substr entLayerName 1 2))
			(setq ikiyuzon (getEntPro currentEnt 210))
			(setq tempHolePos (trans tempHolePos ikiyuzon 0))
			;Güvenlik
			(if (> tempHoleDepth 35)
				(alert (sprintf "Takým çarpma riski hasýl oldu!!!\n ~s -> ~s\n Delik derinliði: ~d" (list (lmm_getDXFFileNameByFileMode (list currentPanel))
																					entLayerName
																					tempHoleDepth)))
			)
			(princ (sprintf "~s VD~s VE~s VF~s VG~s VH0\n" (list (nth 1 tempCAMStyle)
						 (lmm_convertNumtoStringWithDigit (getnth 0 tempHolePos) 2)
						  (lmm_convertNumtoStringWithDigit (getnth 1 tempHolePos) 2)
						  (lmm_convertNumtoStringWithDigit (* -1 (getnth 2 tempHolePos)) 2)
						   (lmm_convertNumtoStringWithDigit tempHoleDepth 2)
						)) file)
			
			
		)
		( (equal "O5" (substr entLayerName 1 2))
			(setq ikiyuzon (getEntPro currentEnt 210))
			(setq tempHolePos (trans tempHolePos ikiyuzon 0))
			;Güvenlik
			(if (> tempHoleDepth 35)
				(alert (sprintf "Takým çarpma riski hasýl oldu!!!\n ~s -> ~s\n Delik derinliði: ~d" (list (lmm_getDXFFileNameByFileMode (list currentPanel))
																					entLayerName
																					tempHoleDepth)))
			)
			(princ (sprintf "~s VD~s VE~s VF~s VG~s VH0\n" (list (nth 1 tempCAMStyle)
						 (lmm_convertNumtoStringWithDigit (getnth 0 tempHolePos) 2)
						  (lmm_convertNumtoStringWithDigit (getnth 1 tempHolePos) 2)
						  (lmm_convertNumtoStringWithDigit (* -1 (getnth 2 tempHolePos)) 2)
						   (lmm_convertNumtoStringWithDigit tempHoleDepth 2)
						)) file)
			
			
		)
		( (equal "O4" (substr entLayerName 1 2))
			(setq ikiyuzon (getEntPro currentEnt 210))
			(setq tempHolePos (trans tempHolePos ikiyuzon 0))
			;Güvenlik
			(if (> tempHoleDepth 35)
				(alert (sprintf "Takým çarpma riski hasýl oldu!!!\n ~s -> ~s\n Delik derinliði: ~d" (list (lmm_getDXFFileNameByFileMode (list currentPanel))
																					entLayerName
																					tempHoleDepth)))
			)
			(princ (sprintf "~s VD~s VE~s VF~s VG~s VH0\n" (list (nth 1 tempCAMStyle)
						 (lmm_convertNumtoStringWithDigit (getnth 0 tempHolePos) 2)
						  (lmm_convertNumtoStringWithDigit (getnth 1 tempHolePos) 2)
						  (lmm_convertNumtoStringWithDigit (* -1 (getnth 2 tempHolePos)) 2)
						   (lmm_convertNumtoStringWithDigit tempHoleDepth 2)
						)) file)
			
		
		)
	)
)
 
 
(setq omaksanAllEntities nil)
(setq omaksanNotFreeEntities nil)
(setq omaksanEntitiesThatCanNotBeCAM nil) ; iþlen atanamayan layerlarý toplamak için. Eðer bu liste doluysa "Bu layerlara iþlem ypaýlmadýðýný bildirir"
(setq omaksanIgnoreLayerNameList (list "0" "PANEL" "LMM_EDGESTRIP")) ; bu layerlara iþlem yapýlmadý diye carlamaz

(setq m12m16State (list nil nil))
 
(setq lmm_exportOmaksanGCodesDesiredCAMOp nil)
(defun lmm_exportOmaksanGCodesDesiredCAMOp ( /  gCodeFilesPath allPanelsList tempPanel gCodeFile tempPanelLength tempPanelWidth
												tempPanelDepth tempPanelName currentOp tempEnt tempPanelSS tempPanelSSList tempEntityLayerName
												tempOpLayerName  tempOpOpName tempDerivedLayerName tempHoleDia tempIter alertMsg
												  )
	(setq omaksanAllEntities nil)
	(setq omaksanNotFreeEntities nil)
	(setq omaksanEntitiesThatCanNotBeCAM nil)
						  
												                                                     
	;þimdi burda verilen layer isimlerine ve sýrasýna göre cam opersayonlarýný oluþtumak gerekiyor.
	;önce kullanýcýnýn tanýmladýðý cam programalý listesine göre
	; her defasýna tüm entitileri getirelim ve uygun cam oprasyonun uygulayalým
	; temelde Z-, X+, X-, Y+, Y-, grove ve profile cam  7 adet operasyonlarý var
	(setq gCodeFilesPath (strcat (lmm_prepareOutDirs) "\\"))
	(setq allPanelsList (lmm_getAllPanelsList))
	(foreach tempPanel allPanelsList
		(setq m12m16State (list nil nil))	
		(setq tempPanelName (lmm_getLMMdata tempPanel lmm-k-customCode))
		(setq tempPanelDepth (lmm_getLMMdata tempPanel lmm-k-depth))
		(setq tempPanelLength (getnth 2 (getBBox tempPanel)))
		(setq tempPanelWidth (getnth 3 (getBBox tempPanel)))
		(setq gCodeFile (open (strcat gCodeFilesPath (lmm_getDXFFileNameByFileMode (list tempPanel)) ".nc") "w"))
		;(write-line "%" gCodeFile)
		(setq tempPanelLength (lmm_convertNumtoStringWithDigit tempPanelLength 3))
		(setq tempPanelWidth (lmm_convertNumtoStringWithDigit tempPanelWidth 3))
		(setq tempPanelDepth (lmm_convertNumtoStringWithDigit tempPanelDepth 3))
		;(write-line (strcat "//" tempPanelName) gCodeFile)
		(write-line (strcat "G90 G17 G500\n"
		"G64 G21 G49\n"
		"G40\n"
		"P11=" tempPanelLength "\np12=" tempPanelWidth "\nP13=" tempPanelDepth "\nP14=122.32" "\nP15=" (lmm_convertNumtoStringWithDigit (- (atof tempPanelLength) 153) 3) "\n"
		"G00 X0.00 Y0.00 Z0.00\n"
		"S10 M03") gCodeFile)
		
		(setq tempPanelDepth (atof tempPanelDepth))
		(setq tempPanelLength (atof tempPanelLength))
		(setq tempPanelWidth (atof tempPanelWidth))
		(setq tempPanelSS (lmm_getComponentWithChild tempPanel "ALL"))
		(setq tempPanelSSList (convertSStolist tempPanelSS))
		(setq tempPanelSSList (entOptimization tempPanelSSList))
		(foreach currentOp ad_OmaksanCAMOperationList
			(setq tempOpLayerName (nth 0 currentOp))
			(setq tempOpOpName (nth 2 currentOp))
			;(setq tempPanelSSListRelatedOp (getOpRelatedEnts tempPanelSSList currentOp))	
			;(write-line (strcat "//CAM_OP "  tempOpLayerName tempOpToolName tempOpOpName) gCodeFile)
			(foreach tempEnt tempPanelSSList
				(if (equal (lmm_getLMMdata tempEnt lmm-k-type) "HOLE") ; delikler geometrisine göre yorumlanýyor
					(progn 
						(setq tempHoleDia (lmm_getLMMdata tempEnt lmm-k-diameter))
						(cond 
							( ;Z - TOP  
								(equal (getnth 2 (getEntPro tempEnt 210)) 1.00000)
								(setq tempDerivedLayerName "O1_" )
							)
							( ;X - RIGH
								(equal (getnth 0 (getEntPro tempEnt 210)) 1.000000)
								(setq tempDerivedLayerName "O3_" )
							)
							( ;X + LEFT
								(equal (getnth 0 (getEntPro tempEnt 210)) -1.000000)
								(setq tempDerivedLayerName "O2_" )
							)
							( ;Y - REAR
								(equal (getnth 1 (getEntPro tempEnt 210)) 1.000000)
								(setq tempDerivedLayerName "O5_" )
							)
							( ;Y + FRONT
								(equal (getnth 1 (getEntPro tempEnt 210)) -1.000000)
								(setq tempDerivedLayerName "O4_" )
							)
						)
						(setq tempDerivedLayerName (strcat tempDerivedLayerName (lmm_convertNumtoStringWithDigit tempHoleDia 1) ))
					)
					(progn 
						(setq tempDerivedLayerName (getentpro  tempEnt 8 ))
					)
				)
				
				;Ýþlem yapýlamayan layer ismindeki varlýklarý yakalamk için tüm layerlarý *AllEntities te topluyoruz
				(if (not (member tempDerivedLayerName omaksanIgnoreLayerNameList))
					(if  (not (member (strcat tempPanelName "->"  tempDerivedLayerName) omaksanAllEntities))
						(setq omaksanAllEntities (append omaksanAllEntities (list (strcat tempPanelName "->"  tempDerivedLayerName))))
					)
				)
				
				(if (equal tempDerivedLayerName tempOpLayerName) ;; cam yapýlmasý gereken etity
					(progn
						(cond 
							((equal tempOpOpName "HOLE") ; üst, sol,sað,arka,ön delik iþlemi
								(omaksanV2HoleCAMOperation tempEnt tempDerivedLayerName currentOp tempPanel gCodeFile)
								
								;Ýþlem yapýlamayan layer ismindeki varlýklarý yakalamk için tüm iþlem yapýlan varlýklarý *NotFreeEntities de topluyoruz
								(setq omaksanNotFreeEntities (append omaksanNotFreeEntities (list (strcat tempPanelName "->" tempDerivedLayerName))))
							) 
							((equal tempOpOpName "SAWX") ;testere iþlemi
								(omaksanV2SawCAMOperation tempEnt  currentOp tempPanelDepth gCodeFile)	
								
								;Ýþlem yapýlamayan layer ismindeki varlýklarý yakalamk için tüm iþlem yapýlan varlýklarý *NotFreeEntities de topluyoruz
								(setq omaksanNotFreeEntities (append omaksanNotFreeEntities (list (strcat tempPanelName "->" tempDerivedLayerName))))
							)
							((equal tempOpOpName "MILLING") ;freze iþlemi
								(omaksanV2MillingCAMOperation tempEnt tempOpLayerName currentOp tempPanel gCodeFile)	
								
								;Ýþlem yapýlamayan layer ismindeki varlýklarý yakalamk için tüm iþlem yapýlan varlýklarý *NotFreeEntities de topluyoruz
								(setq omaksanNotFreeEntities (append omaksanNotFreeEntities (list (strcat tempPanelName "->" tempDerivedLayerName))))
							)
						)
					)
				)
			)
		)
		
		;check m12 state
		(if (not (nth 0 m12m16State))
			(progn
				(setq m12m16State (list T (nth 1 m12m16State)))
				(princ "M12\n" gCodeFile)
			)
		)
		;check m16 state
		(if (not (nth 1 m12m16State))
			(progn
				(setq m12m16State (list (nth 0 m12m16State) T))
				(princ "M16\n" gCodeFile)
			)
		)
		(write-line "G0 X0.00 Y0.00 Z0.00\nM17\nM30" gCodeFile)
		(close gCodeFile)
	)
	
	;Ýþlem yapýlamayan layer ismindeki varlýklarý yakalamak için tüm varlýklara iþlem yapýlýp yapýmadýðý kontrol ediliyor 
	(foreach tempItem omaksanAllEntities
		(if (and (not (member tempItem omaksanNotFreeEntities)) (not (member tempItem omaksanEntitiesThatCanNotBeCAM)))
			(setq omaksanEntitiesThatCanNotBeCAM (append omaksanEntitiesThatCanNotBeCAM (list tempItem)))
		)
	)
	
	;Eðer iþlem yapýlamayan varlýk varsa bunu kullanýcýya bildir.
	(if omaksanEntitiesThatCanNotBeCAM
		(progn
			(setq omaksanEntitiesThatCanNotBeCAM (append (list (xstr "No CAM operation is defined for entities below.")) omaksanEntitiesThatCanNotBeCAM ))
			(setq tempIter 0 alertMsg "")
			(repeat (1- (length omaksanEntitiesThatCanNotBeCAM))
				(setq alertMsg (strcat alertMsg (nth tempIter omaksanEntitiesThatCanNotBeCAM) "\n"))
				(setq tempIter (+ tempIter 1))
			)
			(setq alertMsg (strcat alertMsg (nth tempIter omaksanEntitiesThatCanNotBeCAM)))
			(alert alertMsg)
		)
		;(yesNo (xstr "görünen o ki ok her yolunda"))
	)

	
)

(princ)
